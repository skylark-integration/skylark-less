{"version":3,"sources":["skylark-less.js"],"names":["addDataAttr","require","browser","module","exports","window","options","document","less","environment","FileManager","logger","fileManager","addFileManager","PluginLoader","errors","cache","functions","functionRegistry","addMultiple","typePattern","clone","obj","cloned","prop","hasOwnProperty","bind","func","thisArg","curryArgs","Array","prototype","slice","call","arguments","args","concat","apply","loadStyles","modifyVars","style","styles","getElementsByTagName","i","length","type","match","instanceOptions","lessText","innerHTML","filename","location","href","replace","render","e","result","add","styleSheet","cssText","css","loadStyleSheet","sheet","callback","reload","remaining","mime","loadFile","then","loadedFile","data","contents","path","webInfo","newFileInfo","currentDirectory","getPath","rootFilename","rewriteUrls","entryPath","rootpath","getCSS","local","remove","rootFileInfo","setCSS","lastModified","loadInitialFileCallback","catch","err","console","log","loadStyleSheets","sheets","watch","watchMode","env","watchTimer","setInterval","clearFileCache","_","createCSS","poll","this","unwatch","clearInterval","registerStylesheetsImmediately","links","rel","push","registerStylesheets","Promise","resolve","reject","record","refresh","startTime","endTime","totalMilliseconds","remainingSheets","Date","info","refreshStyles","define","skylark","main"],"mappings":"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","file":"../skylark-less.js","sourcesContent":["var addDataAttr = require('./utils').addDataAttr, browser = require('./browser');\nmodule.exports = function (window, options) {\n    var document = window.document;\n    var less = require('../less')();\n    less.options = options;\n    var environment = less.environment, FileManager = require('./file-manager')(options, less.logger), fileManager = new FileManager();\n    environment.addFileManager(fileManager);\n    less.FileManager = FileManager;\n    less.PluginLoader = require('./plugin-loader');\n    require('./log-listener')(less, options);\n    var errors = require('./error-reporting')(window, less, options);\n    var cache = less.cache = options.cache || require('./cache')(window, options, less.logger);\n    require('./image-size')(less.environment);\n    if (options.functions) {\n        less.functions.functionRegistry.addMultiple(options.functions);\n    }\n    var typePattern = /^text\\/(x-)?less$/;\n    function clone(obj) {\n        var cloned = {};\n        for (var prop in obj) {\n            if (obj.hasOwnProperty(prop)) {\n                cloned[prop] = obj[prop];\n            }\n        }\n        return cloned;\n    }\n    function bind(func, thisArg) {\n        var curryArgs = Array.prototype.slice.call(arguments, 2);\n        return function () {\n            var args = curryArgs.concat(Array.prototype.slice.call(arguments, 0));\n            return func.apply(thisArg, args);\n        };\n    }\n    function loadStyles(modifyVars) {\n        var styles = document.getElementsByTagName('style'), style;\n        for (var i = 0; i < styles.length; i++) {\n            style = styles[i];\n            if (style.type.match(typePattern)) {\n                var instanceOptions = clone(options);\n                instanceOptions.modifyVars = modifyVars;\n                var lessText = style.innerHTML || '';\n                instanceOptions.filename = document.location.href.replace(/#.*$/, '');\n                less.render(lessText, instanceOptions, bind(function (style, e, result) {\n                    if (e) {\n                        errors.add(e, 'inline');\n                    } else {\n                        style.type = 'text/css';\n                        if (style.styleSheet) {\n                            style.styleSheet.cssText = result.css;\n                        } else {\n                            style.innerHTML = result.css;\n                        }\n                    }\n                }, null, style));\n            }\n        }\n    }\n    function loadStyleSheet(sheet, callback, reload, remaining, modifyVars) {\n        var instanceOptions = clone(options);\n        addDataAttr(instanceOptions, sheet);\n        instanceOptions.mime = sheet.type;\n        if (modifyVars) {\n            instanceOptions.modifyVars = modifyVars;\n        }\n        function loadInitialFileCallback(loadedFile) {\n            var data = loadedFile.contents, path = loadedFile.filename, webInfo = loadedFile.webInfo;\n            var newFileInfo = {\n                currentDirectory: fileManager.getPath(path),\n                filename: path,\n                rootFilename: path,\n                rewriteUrls: instanceOptions.rewriteUrls\n            };\n            newFileInfo.entryPath = newFileInfo.currentDirectory;\n            newFileInfo.rootpath = instanceOptions.rootpath || newFileInfo.currentDirectory;\n            if (webInfo) {\n                webInfo.remaining = remaining;\n                var css = cache.getCSS(path, webInfo, instanceOptions.modifyVars);\n                if (!reload && css) {\n                    webInfo.local = true;\n                    callback(null, css, data, sheet, webInfo, path);\n                    return;\n                }\n            }\n            errors.remove(path);\n            instanceOptions.rootFileInfo = newFileInfo;\n            less.render(data, instanceOptions, function (e, result) {\n                if (e) {\n                    e.href = path;\n                    callback(e);\n                } else {\n                    cache.setCSS(sheet.href, webInfo.lastModified, instanceOptions.modifyVars, result.css);\n                    callback(null, result.css, data, sheet, webInfo, path);\n                }\n            });\n        }\n        fileManager.loadFile(sheet.href, null, instanceOptions, environment).then(function (loadedFile) {\n            loadInitialFileCallback(loadedFile);\n        }).catch(function (err) {\n            console.log(err);\n            callback(err);\n        });\n    }\n    function loadStyleSheets(callback, reload, modifyVars) {\n        for (var i = 0; i < less.sheets.length; i++) {\n            loadStyleSheet(less.sheets[i], callback, reload, less.sheets.length - (i + 1), modifyVars);\n        }\n    }\n    function initRunningMode() {\n        if (less.env === 'development') {\n            less.watchTimer = setInterval(function () {\n                if (less.watchMode) {\n                    fileManager.clearFileCache();\n                    loadStyleSheets(function (e, css, _, sheet, webInfo) {\n                        if (e) {\n                            errors.add(e, e.href || sheet.href);\n                        } else if (css) {\n                            browser.createCSS(window.document, css, sheet);\n                        }\n                    });\n                }\n            }, options.poll);\n        }\n    }\n    less.watch = function () {\n        if (!less.watchMode) {\n            less.env = 'development';\n            initRunningMode();\n        }\n        this.watchMode = true;\n        return true;\n    };\n    less.unwatch = function () {\n        clearInterval(less.watchTimer);\n        this.watchMode = false;\n        return false;\n    };\n    less.registerStylesheetsImmediately = function () {\n        var links = document.getElementsByTagName('link');\n        less.sheets = [];\n        for (var i = 0; i < links.length; i++) {\n            if (links[i].rel === 'stylesheet/less' || links[i].rel.match(/stylesheet/) && links[i].type.match(typePattern)) {\n                less.sheets.push(links[i]);\n            }\n        }\n    };\n    less.registerStylesheets = function () {\n        return new Promise(function (resolve, reject) {\n            less.registerStylesheetsImmediately();\n            resolve();\n        });\n    };\n    less.modifyVars = function (record) {\n        return less.refresh(true, record, false);\n    };\n    less.refresh = function (reload, modifyVars, clearFileCache) {\n        if ((reload || clearFileCache) && clearFileCache !== false) {\n            fileManager.clearFileCache();\n        }\n        return new Promise(function (resolve, reject) {\n            var startTime, endTime, totalMilliseconds, remainingSheets;\n            startTime = endTime = new Date();\n            remainingSheets = less.sheets.length;\n            if (remainingSheets === 0) {\n                endTime = new Date();\n                totalMilliseconds = endTime - startTime;\n                less.logger.info('Less has finished and no sheets were loaded.');\n                resolve({\n                    startTime: startTime,\n                    endTime: endTime,\n                    totalMilliseconds: totalMilliseconds,\n                    sheets: less.sheets.length\n                });\n            } else {\n                loadStyleSheets(function (e, css, _, sheet, webInfo) {\n                    if (e) {\n                        errors.add(e, e.href || sheet.href);\n                        reject(e);\n                        return;\n                    }\n                    if (webInfo.local) {\n                        less.logger.info('Loading ' + sheet.href + ' from cache.');\n                    } else {\n                        less.logger.info('Rendered ' + sheet.href + ' successfully.');\n                    }\n                    browser.createCSS(window.document, css, sheet);\n                    less.logger.info('CSS for ' + sheet.href + ' generated in ' + (new Date() - endTime) + 'ms');\n                    remainingSheets--;\n                    if (remainingSheets === 0) {\n                        totalMilliseconds = new Date() - startTime;\n                        less.logger.info('Less has finished. CSS generated in ' + totalMilliseconds + 'ms');\n                        resolve({\n                            startTime: startTime,\n                            endTime: endTime,\n                            totalMilliseconds: totalMilliseconds,\n                            sheets: less.sheets.length\n                        });\n                    }\n                    endTime = new Date();\n                }, reload, modifyVars);\n            }\n            loadStyles(modifyVars);\n        });\n    };\n    less.refreshStyles = loadStyles;\n    return less;\n};\ndefine(\"skylark-less/browser/index\", function(){});\n\ndefine('skylark-less/less',[\r\n\t\"skylark-langx/skylark\",\r\n\t\"./browser/index\"\r\n],function(skylark,less){\r\n\treturn skylark.less = less;\r\n});\ndefine('skylark-less/main',[\r\n\t\"./less\"\r\n],function(less){\r\n\treturn less;\r\n});\ndefine('skylark-less', ['skylark-less/main'], function (main) { return main; });\n\n"]}