/**
 * skylark-less - A version of less.js that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylarkui/skylark-less/
 * @license MIT
 */
define(["../tree/index","./visitor"],function(i,t){"use strict";var e={},n={exports:{}},s=i,r=t,o=function(i){this._visitor=new r(this),this._context=i};o.prototype={containsSilentNonBlockedChild:function(i){var t;if(!i)return!1;for(var e=0;e<i.length;e++)if((t=i[e]).isSilent&&t.isSilent(this._context)&&!t.blocksVisibility())return!0;return!1},keepOnlyVisibleChilds:function(i){i&&i.rules&&(i.rules=i.rules.filter(function(i){return i.isVisible()}))},isEmpty:function(i){return!i||!i.rules||0===i.rules.length},hasVisibleSelector:function(i){return!(!i||!i.paths)&&i.paths.length>0},resolveVisibility:function(i,t){if(!i.blocksVisibility()){if(this.isEmpty(i)&&!this.containsSilentNonBlockedChild(t))return;return i}var e=i.rules[0];if(this.keepOnlyVisibleChilds(e),!this.isEmpty(e))return i.ensureVisibility(),i.removeVisibilityBlock(),i},isVisibleRuleset:function(i){return!!i.firstRoot||!this.isEmpty(i)&&!(!i.root&&!this.hasVisibleSelector(i))}};var l=function(i){this._visitor=new r(this),this._context=i,this.utils=new o(i)};function u(i){return"object"!=typeof i||Array.isArray(i)||!function(i){var t;for(t in i)return!1;return!0}(i)}return l.prototype={isReplacing:!0,run:function(i){return this._visitor.visit(i)},visitDeclaration:function(i,t){if(!i.blocksVisibility()&&!i.variable)return i},visitMixinDefinition:function(i,t){i.frames=[]},visitExtend:function(i,t){},visitComment:function(i,t){if(!i.blocksVisibility()&&!i.isSilent(this._context))return i},visitMedia:function(i,t){var e=i.rules[0].rules;return i.accept(this._visitor),t.visitDeeper=!1,this.utils.resolveVisibility(i,e)},visitImport:function(i,t){if(!i.blocksVisibility())return i},visitAtRule:function(i,t){return i.rules&&i.rules.length?this.visitAtRuleWithBody(i,t):this.visitAtRuleWithoutBody(i,t)},visitAnonymous:function(i,t){if(!i.blocksVisibility())return i.accept(this._visitor),i},visitAtRuleWithBody:function(i,t){var e=function(i){var t=i.rules;return function(i){var t=i.rules;return 1===t.length&&(!t[0].paths||0===t[0].paths.length)}(i)?t[0].rules:t}(i);return i.accept(this._visitor),t.visitDeeper=!1,this.utils.isEmpty(i)||this._mergeRules(i.rules[0].rules),this.utils.resolveVisibility(i,e)},visitAtRuleWithoutBody:function(i,t){if(!i.blocksVisibility()){if("@charset"===i.name){if(this.charset){if(i.debugInfo){var e=new s.Comment("/* "+i.toCSS(this._context).replace(/\n/g,"")+" */\n");return e.debugInfo=i.debugInfo,this._visitor.visit(e)}return}this.charset=!0}return i}},checkValidNodes:function(i,t){if(i)for(var e=0;e<i.length;e++){var n=i[e];if(t&&n instanceof s.Declaration&&!n.variable)throw{message:"Properties must be inside selector blocks. They cannot be in the root",index:n.getIndex(),filename:n.fileInfo()&&n.fileInfo().filename};if(n instanceof s.Call)throw{message:"Function '"+n.name+"' is undefined",index:n.getIndex(),filename:n.fileInfo()&&n.fileInfo().filename};if(n.type&&!n.allowRoot)throw{message:n.type+" node returned by a function is not valid here",index:n.getIndex(),filename:n.fileInfo()&&n.fileInfo().filename}}},visitRuleset:function(i,t){var e,n=[];if(this.checkValidNodes(i.rules,i.firstRoot),i.root)i.accept(this._visitor),t.visitDeeper=!1;else{this._compileRulesetPaths(i);for(var s=i.rules,r=s?s.length:0,o=0;o<r;)(e=s[o])&&e.rules?(n.push(this._visitor.visit(e)),s.splice(o,1),r--):o++;r>0?i.accept(this._visitor):i.rules=null,t.visitDeeper=!1}return i.rules&&(this._mergeRules(i.rules),this._removeDuplicateRules(i.rules)),this.utils.isVisibleRuleset(i)&&(i.ensureVisibility(),n.splice(0,0,i)),1===n.length?n[0]:n},_compileRulesetPaths:function(i){i.paths&&(i.paths=i.paths.filter(function(i){var t;for(" "===i[0].elements[0].combinator.value&&(i[0].elements[0].combinator=new s.Combinator("")),t=0;t<i.length;t++)if(i[t].isVisible()&&i[t].getIsOutput())return!0;return!1}))},_removeDuplicateRules:function(i){if(i){var t,e,n,r={};for(n=i.length-1;n>=0;n--)if((e=i[n])instanceof s.Declaration)if(r[e.name]){(t=r[e.name])instanceof s.Declaration&&(t=r[e.name]=[r[e.name].toCSS(this._context)]);var o=e.toCSS(this._context);-1!==t.indexOf(o)?i.splice(n,1):t.push(o)}else r[e.name]=e}},_mergeRules:function(i){if(i){for(var t={},e=[],n=0;n<i.length;n++){var r=i[n];if(r.merge){var o=r.name;t[o]?i.splice(n--,1):e.push(t[o]=[]),t[o].push(r)}}e.forEach(function(i){if(i.length>0){var t=i[0],e=[],n=[new s.Expression(e)];i.forEach(function(i){"+"===i.merge&&e.length>0&&n.push(new s.Expression(e=[])),e.push(i.value),t.important=t.important||i.important}),t.value=new s.Value(n)}})}}},n.exports=l,u(n.exports)?n.exports:u(e)?e:void 0});
//# sourceMappingURL=../../sourcemaps/engine/visitors/to-css-visitor.js.map
