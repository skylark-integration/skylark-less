/**
 * skylark-less - A version of less.js that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylarkui/skylark-less/
 * @license MIT
 */
var tree=require("../tree"),Visitor=require("./visitor"),logger=require("../logger"),utils=require("../utils"),ExtendFinderVisitor=function(){this._visitor=new Visitor(this),this.contexts=[],this.allExtendsStack=[[]]};ExtendFinderVisitor.prototype={run:function(e){return(e=this._visitor.visit(e)).allExtends=this.allExtendsStack[0],e},visitDeclaration:function(e,t){t.visitDeeper=!1},visitMixinDefinition:function(e,t){t.visitDeeper=!1},visitRuleset:function(e,t){if(!e.root){var n,i,s,l,a=[],r=e.rules,o=r?r.length:0;for(n=0;n<o;n++)e.rules[n]instanceof tree.Extend&&(a.push(r[n]),e.extendOnEveryPath=!0);var c=e.paths;for(n=0;n<c.length;n++){var h=c[n],u=h[h.length-1].extendList;for((l=u?utils.copyArray(u).concat(a):a)&&(l=l.map(function(e){return e.clone()})),i=0;i<l.length;i++)this.foundExtends=!0,(s=l[i]).findSelfSelectors(h),s.ruleset=e,0===i&&(s.firstExtendOnThisSelectorPath=!0),this.allExtendsStack[this.allExtendsStack.length-1].push(s)}this.contexts.push(e.selectors)}},visitRulesetOut:function(e){e.root||(this.contexts.length=this.contexts.length-1)},visitMedia:function(e,t){e.allExtends=[],this.allExtendsStack.push(e.allExtends)},visitMediaOut:function(e){this.allExtendsStack.length=this.allExtendsStack.length-1},visitAtRule:function(e,t){e.allExtends=[],this.allExtendsStack.push(e.allExtends)},visitAtRuleOut:function(e){this.allExtendsStack.length=this.allExtendsStack.length-1}};var ProcessExtendsVisitor=function(){this._visitor=new Visitor(this)};ProcessExtendsVisitor.prototype={run:function(e){var t=new ExtendFinderVisitor;if(this.extendIndices={},t.run(e),!t.foundExtends)return e;e.allExtends=e.allExtends.concat(this.doExtendChaining(e.allExtends,e.allExtends)),this.allExtendsStack=[e.allExtends];var n=this._visitor.visit(e);return this.checkExtendsForNonMatched(e.allExtends),n},checkExtendsForNonMatched:function(e){var t=this.extendIndices;e.filter(function(e){return!e.hasFoundMatches&&1==e.parent_ids.length}).forEach(function(e){var n="_unknown_";try{n=e.selector.toCSS({})}catch(e){}t[e.index+" "+n]||(t[e.index+" "+n]=!0,logger.warn("extend '"+n+"' has no matches"))})},doExtendChaining:function(e,t,n){var i,s,l,a,r,o,c,h,u=[],d=this;for(n=n||0,i=0;i<e.length;i++)for(s=0;s<t.length;s++)o=e[i],c=t[s],o.parent_ids.indexOf(c.object_id)>=0||(r=[c.selfSelectors[0]],(l=d.findMatch(o,r)).length&&(o.hasFoundMatches=!0,o.selfSelectors.forEach(function(e){var t=c.visibilityInfo();a=d.extendSelector(l,r,e,o.isVisible()),(h=new tree.Extend(c.selector,c.option,0,c.fileInfo(),t)).selfSelectors=a,a[a.length-1].extendList=[h],u.push(h),h.ruleset=c.ruleset,h.parent_ids=h.parent_ids.concat(c.parent_ids,o.parent_ids),c.firstExtendOnThisSelectorPath&&(h.firstExtendOnThisSelectorPath=!0,c.ruleset.paths.push(a))})));if(u.length){if(this.extendChainCount++,n>100){var f="{unable to calculate}",x="{unable to calculate}";try{f=u[0].selfSelectors[0].toCSS(),x=u[0].selector.toCSS()}catch(e){}throw{message:"extend circular reference detected. One of the circular extends is currently:"+f+":extend("+x+")"}}return u.concat(d.doExtendChaining(u,t,n+1))}return u},visitDeclaration:function(e,t){t.visitDeeper=!1},visitMixinDefinition:function(e,t){t.visitDeeper=!1},visitSelector:function(e,t){t.visitDeeper=!1},visitRuleset:function(e,t){if(!e.root){var n,i,s,l,a=this.allExtendsStack[this.allExtendsStack.length-1],r=[],o=this;for(s=0;s<a.length;s++)for(i=0;i<e.paths.length;i++)if(l=e.paths[i],!e.extendOnEveryPath){var c=l[l.length-1].extendList;c&&c.length||(n=this.findMatch(a[s],l)).length&&(a[s].hasFoundMatches=!0,a[s].selfSelectors.forEach(function(e){var t;t=o.extendSelector(n,l,e,a[s].isVisible()),r.push(t)}))}e.paths=e.paths.concat(r)}},findMatch:function(e,t){var n,i,s,l,a,r,o,c=e.selector.elements,h=[],u=[];for(n=0;n<t.length;n++)for(i=t[n],s=0;s<i.elements.length;s++)for(l=i.elements[s],(e.allowBefore||0===n&&0===s)&&h.push({pathIndex:n,index:s,matched:0,initialCombinator:l.combinator}),r=0;r<h.length;r++)o=h[r],""===(a=l.combinator.value)&&0===s&&(a=" "),!this.isElementValuesEqual(c[o.matched].value,l.value)||o.matched>0&&c[o.matched].combinator.value!==a?o=null:o.matched++,o&&(o.finished=o.matched===c.length,o.finished&&!e.allowAfter&&(s+1<i.elements.length||n+1<t.length)&&(o=null)),o?o.finished&&(o.length=c.length,o.endPathIndex=n,o.endPathElementIndex=s+1,h.length=0,u.push(o)):(h.splice(r,1),r--);return u},isElementValuesEqual:function(e,t){if("string"==typeof e||"string"==typeof t)return e===t;if(e instanceof tree.Attribute)return e.op===t.op&&e.key===t.key&&(e.value&&t.value?(e=e.value.value||e.value)===(t=t.value.value||t.value):!e.value&&!t.value);if(e=e.value,t=t.value,e instanceof tree.Selector){if(!(t instanceof tree.Selector)||e.elements.length!==t.elements.length)return!1;for(var n=0;n<e.elements.length;n++){if(e.elements[n].combinator.value!==t.elements[n].combinator.value&&(0!==n||(e.elements[n].combinator.value||" ")!==(t.elements[n].combinator.value||" ")))return!1;if(!this.isElementValuesEqual(e.elements[n].value,t.elements[n].value))return!1}return!0}return!1},extendSelector:function(e,t,n,i){var s,l,a,r,o,c=0,h=0,u=[];for(s=0;s<e.length;s++)l=t[(r=e[s]).pathIndex],a=new tree.Element(r.initialCombinator,n.elements[0].value,n.elements[0].isVariable,n.elements[0].getIndex(),n.elements[0].fileInfo()),r.pathIndex>c&&h>0&&(u[u.length-1].elements=u[u.length-1].elements.concat(t[c].elements.slice(h)),h=0,c++),o=l.elements.slice(h,r.index).concat([a]).concat(n.elements.slice(1)),c===r.pathIndex&&s>0?u[u.length-1].elements=u[u.length-1].elements.concat(o):(u=u.concat(t.slice(c,r.pathIndex))).push(new tree.Selector(o)),c=r.endPathIndex,(h=r.endPathElementIndex)>=t[c].elements.length&&(h=0,c++);return c<t.length&&h>0&&(u[u.length-1].elements=u[u.length-1].elements.concat(t[c].elements.slice(h)),c++),u=(u=u.concat(t.slice(c,t.length))).map(function(e){var t=e.createDerived(e.elements);return i?t.ensureVisibility():t.ensureInvisibility(),t})},visitMedia:function(e,t){var n=e.allExtends.concat(this.allExtendsStack[this.allExtendsStack.length-1]);n=n.concat(this.doExtendChaining(n,e.allExtends)),this.allExtendsStack.push(n)},visitMediaOut:function(e){var t=this.allExtendsStack.length-1;this.allExtendsStack.length=t},visitAtRule:function(e,t){var n=e.allExtends.concat(this.allExtendsStack[this.allExtendsStack.length-1]);n=n.concat(this.doExtendChaining(n,e.allExtends)),this.allExtendsStack.push(n)},visitAtRuleOut:function(e){var t=this.allExtendsStack.length-1;this.allExtendsStack.length=t}},module.exports=ProcessExtendsVisitor;
//# sourceMappingURL=../../sourcemaps/engine/visitors/extend-visitor.js.map
