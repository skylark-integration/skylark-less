/**
 * skylark-less - A version of less.js that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylarkui/skylark-less/
 * @license MIT
 */
define(["../tree/index","./visitor","../logger","../utils"],function(e,t,n,i){"use strict";var l={},s={exports:{}},a=e,r=t,c=n,o=i,h=function(){this._visitor=new r(this),this.contexts=[],this.allExtendsStack=[[]]};h.prototype={run:function(e){return(e=this._visitor.visit(e)).allExtends=this.allExtendsStack[0],e},visitDeclaration:function(e,t){t.visitDeeper=!1},visitMixinDefinition:function(e,t){t.visitDeeper=!1},visitRuleset:function(e,t){if(!e.root){var n,i,l,s,r=[],c=e.rules,h=c?c.length:0;for(n=0;n<h;n++)e.rules[n]instanceof a.Extend&&(r.push(c[n]),e.extendOnEveryPath=!0);var u=e.paths;for(n=0;n<u.length;n++){var d=u[n],f=d[d.length-1].extendList;for((s=f?o.copyArray(f).concat(r):r)&&(s=s.map(function(e){return e.clone()})),i=0;i<s.length;i++)this.foundExtends=!0,(l=s[i]).findSelfSelectors(d),l.ruleset=e,0===i&&(l.firstExtendOnThisSelectorPath=!0),this.allExtendsStack[this.allExtendsStack.length-1].push(l)}this.contexts.push(e.selectors)}},visitRulesetOut:function(e){e.root||(this.contexts.length=this.contexts.length-1)},visitMedia:function(e,t){e.allExtends=[],this.allExtendsStack.push(e.allExtends)},visitMediaOut:function(e){this.allExtendsStack.length=this.allExtendsStack.length-1},visitAtRule:function(e,t){e.allExtends=[],this.allExtendsStack.push(e.allExtends)},visitAtRuleOut:function(e){this.allExtendsStack.length=this.allExtendsStack.length-1}};var u=function(){this._visitor=new r(this)};function d(e){return"object"!=typeof e||Array.isArray(e)||!function(e){var t;for(t in e)return!1;return!0}(e)}return u.prototype={run:function(e){var t=new h;if(this.extendIndices={},t.run(e),!t.foundExtends)return e;e.allExtends=e.allExtends.concat(this.doExtendChaining(e.allExtends,e.allExtends)),this.allExtendsStack=[e.allExtends];var n=this._visitor.visit(e);return this.checkExtendsForNonMatched(e.allExtends),n},checkExtendsForNonMatched:function(e){var t=this.extendIndices;e.filter(function(e){return!e.hasFoundMatches&&1==e.parent_ids.length}).forEach(function(e){var n="_unknown_";try{n=e.selector.toCSS({})}catch(e){}t[e.index+" "+n]||(t[e.index+" "+n]=!0,c.warn("extend '"+n+"' has no matches"))})},doExtendChaining:function(e,t,n){var i,l,s,r,c,o,h,u,d=[],f=this;for(n=n||0,i=0;i<e.length;i++)for(l=0;l<t.length;l++)o=e[i],h=t[l],o.parent_ids.indexOf(h.object_id)>=0||(c=[h.selfSelectors[0]],(s=f.findMatch(o,c)).length&&(o.hasFoundMatches=!0,o.selfSelectors.forEach(function(e){var t=h.visibilityInfo();r=f.extendSelector(s,c,e,o.isVisible()),(u=new a.Extend(h.selector,h.option,0,h.fileInfo(),t)).selfSelectors=r,r[r.length-1].extendList=[u],d.push(u),u.ruleset=h.ruleset,u.parent_ids=u.parent_ids.concat(h.parent_ids,o.parent_ids),h.firstExtendOnThisSelectorPath&&(u.firstExtendOnThisSelectorPath=!0,h.ruleset.paths.push(r))})));if(d.length){if(this.extendChainCount++,n>100){var x="{unable to calculate}",v="{unable to calculate}";try{x=d[0].selfSelectors[0].toCSS(),v=d[0].selector.toCSS()}catch(e){}throw{message:"extend circular reference detected. One of the circular extends is currently:"+x+":extend("+v+")"}}return d.concat(f.doExtendChaining(d,t,n+1))}return d},visitDeclaration:function(e,t){t.visitDeeper=!1},visitMixinDefinition:function(e,t){t.visitDeeper=!1},visitSelector:function(e,t){t.visitDeeper=!1},visitRuleset:function(e,t){if(!e.root){var n,i,l,s,a=this.allExtendsStack[this.allExtendsStack.length-1],r=[],c=this;for(l=0;l<a.length;l++)for(i=0;i<e.paths.length;i++)if(s=e.paths[i],!e.extendOnEveryPath){var o=s[s.length-1].extendList;o&&o.length||(n=this.findMatch(a[l],s)).length&&(a[l].hasFoundMatches=!0,a[l].selfSelectors.forEach(function(e){var t;t=c.extendSelector(n,s,e,a[l].isVisible()),r.push(t)}))}e.paths=e.paths.concat(r)}},findMatch:function(e,t){var n,i,l,s,a,r,c,o=e.selector.elements,h=[],u=[];for(n=0;n<t.length;n++)for(i=t[n],l=0;l<i.elements.length;l++)for(s=i.elements[l],(e.allowBefore||0===n&&0===l)&&h.push({pathIndex:n,index:l,matched:0,initialCombinator:s.combinator}),r=0;r<h.length;r++)c=h[r],""===(a=s.combinator.value)&&0===l&&(a=" "),!this.isElementValuesEqual(o[c.matched].value,s.value)||c.matched>0&&o[c.matched].combinator.value!==a?c=null:c.matched++,c&&(c.finished=c.matched===o.length,c.finished&&!e.allowAfter&&(l+1<i.elements.length||n+1<t.length)&&(c=null)),c?c.finished&&(c.length=o.length,c.endPathIndex=n,c.endPathElementIndex=l+1,h.length=0,u.push(c)):(h.splice(r,1),r--);return u},isElementValuesEqual:function(e,t){if("string"==typeof e||"string"==typeof t)return e===t;if(e instanceof a.Attribute)return e.op===t.op&&e.key===t.key&&(e.value&&t.value?(e=e.value.value||e.value)===(t=t.value.value||t.value):!e.value&&!t.value);if(e=e.value,t=t.value,e instanceof a.Selector){if(!(t instanceof a.Selector)||e.elements.length!==t.elements.length)return!1;for(var n=0;n<e.elements.length;n++){if(e.elements[n].combinator.value!==t.elements[n].combinator.value&&(0!==n||(e.elements[n].combinator.value||" ")!==(t.elements[n].combinator.value||" ")))return!1;if(!this.isElementValuesEqual(e.elements[n].value,t.elements[n].value))return!1}return!0}return!1},extendSelector:function(e,t,n,i){var l,s,r,c,o,h=0,u=0,d=[];for(l=0;l<e.length;l++)s=t[(c=e[l]).pathIndex],r=new a.Element(c.initialCombinator,n.elements[0].value,n.elements[0].isVariable,n.elements[0].getIndex(),n.elements[0].fileInfo()),c.pathIndex>h&&u>0&&(d[d.length-1].elements=d[d.length-1].elements.concat(t[h].elements.slice(u)),u=0,h++),o=s.elements.slice(u,c.index).concat([r]).concat(n.elements.slice(1)),h===c.pathIndex&&l>0?d[d.length-1].elements=d[d.length-1].elements.concat(o):(d=d.concat(t.slice(h,c.pathIndex))).push(new a.Selector(o)),h=c.endPathIndex,(u=c.endPathElementIndex)>=t[h].elements.length&&(u=0,h++);return h<t.length&&u>0&&(d[d.length-1].elements=d[d.length-1].elements.concat(t[h].elements.slice(u)),h++),d=(d=d.concat(t.slice(h,t.length))).map(function(e){var t=e.createDerived(e.elements);return i?t.ensureVisibility():t.ensureInvisibility(),t})},visitMedia:function(e,t){var n=e.allExtends.concat(this.allExtendsStack[this.allExtendsStack.length-1]);n=n.concat(this.doExtendChaining(n,e.allExtends)),this.allExtendsStack.push(n)},visitMediaOut:function(e){var t=this.allExtendsStack.length-1;this.allExtendsStack.length=t},visitAtRule:function(e,t){var n=e.allExtends.concat(this.allExtendsStack[this.allExtendsStack.length-1]);n=n.concat(this.doExtendChaining(n,e.allExtends)),this.allExtendsStack.push(n)},visitAtRuleOut:function(e){var t=this.allExtendsStack.length-1;this.allExtendsStack.length=t}},s.exports=u,d(s.exports)?s.exports:d(l)?l:void 0});
//# sourceMappingURL=../../sourcemaps/engine/visitors/extend-visitor.js.map
