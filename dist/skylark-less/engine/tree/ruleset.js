/**
 * skylark-less - A version of less.js that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylarkui/skylark-less/
 * @license MIT
 */
define(["./node","./declaration","./keyword","./comment","./paren","./selector","./element","./anonymous","../contexts","../functions/function-registry","../functions/default","./debug-info","../utils"],function(e,t,r,s,i,n,o,l,a,u,h,p,c){"use strict";var f={},v={exports:{}},y=e,m=t,d=r,g=s,b=i,I=n,w=o,_=l,S=a,C=u,R=h,k=p,A=c,x=function(e,t,r,s){this.selectors=e,this.rules=t,this._lookups={},this._variables=null,this._properties=null,this.strictImports=r,this.copyVisibilityInfo(s),this.allowRoot=!0,this.setParent(this.selectors,this),this.setParent(this.rules,this)};function V(e){return"object"!=typeof e||Array.isArray(e)||!function(e){var t;for(t in e)return!1;return!0}(e)}return(x.prototype=new y).type="Ruleset",x.prototype.isRuleset=!0,x.prototype.isRulesetLike=function(){return!0},x.prototype.accept=function(e){this.paths?this.paths=e.visitArray(this.paths,!0):this.selectors&&(this.selectors=e.visitArray(this.selectors)),this.rules&&this.rules.length&&(this.rules=e.visitArray(this.rules))},x.prototype.eval=function(e){var t,r,s,i,n,o=!1;if(this.selectors&&(r=this.selectors.length)){for(t=new Array(r),R.error({type:"Syntax",message:"it is currently only allowed in parametric mixin guards,"}),i=0;i<r;i++){s=this.selectors[i].eval(e);for(var l=0;l<s.elements.length;l++)if(s.elements[l].isVariable){n=!0;break}t[i]=s,s.evaldCondition&&(o=!0)}if(n){var a=new Array(r);for(i=0;i<r;i++)s=t[i],a[i]=s.toCSS(e);this.parse.parseNode(a.join(","),["selectors"],t[0].getIndex(),t[0].fileInfo(),function(e,r){r&&(t=A.flattenArray(r))})}R.reset()}else o=!0;var u,h,p=this.rules?A.copyArray(this.rules):null,c=new x(t,p,this.strictImports,this.visibilityInfo());c.originalRuleset=this,c.root=this.root,c.firstRoot=this.firstRoot,c.allowImports=this.allowImports,this.debugInfo&&(c.debugInfo=this.debugInfo),o||(p.length=0),c.functionRegistry=function(e){for(var t,r=0,s=e.length;r!==s;++r)if(t=e[r].functionRegistry)return t;return C}(e.frames).inherit();var f=e.frames;f.unshift(c);var v=e.selectors;v||(e.selectors=v=[]),v.unshift(this.selectors),(c.root||c.allowImports||!c.strictImports)&&c.evalImports(e);var d=c.rules;for(i=0;u=d[i];i++)u.evalFirst&&(d[i]=u.eval(e));var g=e.mediaBlocks&&e.mediaBlocks.length||0;for(i=0;u=d[i];i++)"MixinCall"===u.type?(p=u.eval(e).filter(function(e){return!(e instanceof m&&e.variable)||!c.variable(e.name)}),d.splice.apply(d,[i,1].concat(p)),i+=p.length-1,c.resetCache()):"VariableCall"===u.type&&(p=u.eval(e).rules.filter(function(e){return!(e instanceof m&&e.variable)}),d.splice.apply(d,[i,1].concat(p)),i+=p.length-1,c.resetCache());for(i=0;u=d[i];i++)u.evalFirst||(d[i]=u=u.eval?u.eval(e):u);for(i=0;u=d[i];i++)if(u instanceof x&&u.selectors&&1===u.selectors.length&&u.selectors[0]&&u.selectors[0].isJustParentSelector()){d.splice(i--,1);for(l=0;h=u.rules[l];l++)h instanceof y&&(h.copyVisibilityInfo(u.visibilityInfo()),h instanceof m&&h.variable||d.splice(++i,0,h))}if(f.shift(),v.shift(),e.mediaBlocks)for(i=g;i<e.mediaBlocks.length;i++)e.mediaBlocks[i].bubbleSelectors(t);return c},x.prototype.evalImports=function(e){var t,r,s=this.rules;if(s)for(t=0;t<s.length;t++)"Import"===s[t].type&&((r=s[t].eval(e))&&(r.length||0===r.length)?(s.splice.apply(s,[t,1].concat(r)),t+=r.length-1):s.splice(t,1,r),this.resetCache())},x.prototype.makeImportant=function(){return new x(this.selectors,this.rules.map(function(e){return e.makeImportant?e.makeImportant():e}),this.strictImports,this.visibilityInfo())},x.prototype.matchArgs=function(e){return!e||0===e.length},x.prototype.matchCondition=function(e,t){var r=this.selectors[this.selectors.length-1];return!!r.evaldCondition&&!(r.condition&&!r.condition.eval(new S.Eval(t,t.frames)))},x.prototype.resetCache=function(){this._rulesets=null,this._variables=null,this._properties=null,this._lookups={}},x.prototype.variables=function(){return this._variables||(this._variables=this.rules?this.rules.reduce(function(e,t){if(t instanceof m&&!0===t.variable&&(e[t.name]=t),"Import"===t.type&&t.root&&t.root.variables){var r=t.root.variables();for(var s in r)r.hasOwnProperty(s)&&(e[s]=t.root.variable(s))}return e},{}):{}),this._variables},x.prototype.properties=function(){return this._properties||(this._properties=this.rules?this.rules.reduce(function(e,t){if(t instanceof m&&!0!==t.variable){var r=1===t.name.length&&t.name[0]instanceof d?t.name[0].value:t.name;e["$"+r]?e["$"+r].push(t):e["$"+r]=[t]}return e},{}):{}),this._properties},x.prototype.variable=function(e){var t=this.variables()[e];if(t)return this.parseValue(t)},x.prototype.property=function(e){var t=this.properties()[e];if(t)return this.parseValue(t)},x.prototype.lastDeclaration=function(){for(var e=this.rules.length;e>0;e--){var t=this.rules[e-1];if(t instanceof m)return this.parseValue(t)}},x.prototype.parseValue=function(e){var t=this;function r(e){return e.value instanceof _&&!e.parsed?("string"==typeof e.value.value?this.parse.parseNode(e.value.value,["value","important"],e.value.getIndex(),e.fileInfo(),function(t,r){t&&(e.parsed=!0),r&&(e.value=r[0],e.important=r[1]||"",e.parsed=!0)}):e.parsed=!0,e):e}if(Array.isArray(e)){var s=[];return e.forEach(function(e){s.push(r.call(t,e))}),s}return r.call(t,e)},x.prototype.rulesets=function(){if(!this.rules)return[];var e,t,r=[],s=this.rules;for(e=0;t=s[e];e++)t.isRuleset&&r.push(t);return r},x.prototype.prependRule=function(e){var t=this.rules;t?t.unshift(e):this.rules=[e],this.setParent(e,this)},x.prototype.find=function(e,t,r){t=t||this;var s,i,n=[],o=e.toCSS();return o in this._lookups?this._lookups[o]:(this.rulesets().forEach(function(o){if(o!==t)for(var l=0;l<o.selectors.length;l++)if(s=e.match(o.selectors[l])){if(e.elements.length>s){if(!r||r(o)){i=o.find(new I(e.elements.slice(s)),t,r);for(var a=0;a<i.length;++a)i[a].path.push(o);Array.prototype.push.apply(n,i)}}else n.push({rule:o,path:[]});break}}),this._lookups[o]=n,n)},x.prototype.genCSS=function(e,t){var r,s,i,n,o,l=[];e.tabLevel=e.tabLevel||0,this.root||e.tabLevel++;var a,u=e.compress?"":Array(e.tabLevel+1).join("  "),h=e.compress?"":Array(e.tabLevel).join("  "),p=0,c=0;for(r=0;n=this.rules[r];r++)n instanceof g?(c===r&&c++,l.push(n)):n.isCharset&&n.isCharset()?(l.splice(p,0,n),p++,c++):"Import"===n.type?(l.splice(c,0,n),c++):l.push(n);if(l=[].concat(l),!this.root){(i=k(e,this,h))&&(t.add(i),t.add(h));var f,v=this.paths,y=v.length;for(a=e.compress?",":",\n"+h,r=0;r<y;r++)if(f=(o=v[r]).length)for(r>0&&t.add(a),e.firstSelector=!0,o[0].genCSS(e,t),e.firstSelector=!1,s=1;s<f;s++)o[s].genCSS(e,t);t.add((e.compress?"{":" {\n")+u)}for(r=0;n=l[r];r++){r+1===l.length&&(e.lastRule=!0);var m=e.lastRule;n.isRulesetLike(n)&&(e.lastRule=!1),n.genCSS?n.genCSS(e,t):n.value&&t.add(n.value.toString()),e.lastRule=m,!e.lastRule&&n.isVisible()?t.add(e.compress?"":"\n"+u):e.lastRule=!1}this.root||(t.add(e.compress?"}":"\n"+h+"}"),e.tabLevel--),t.isEmpty()||e.compress||!this.firstRoot||t.add("\n")},x.prototype.joinSelectors=function(e,t,r){for(var s=0;s<r.length;s++)this.joinSelector(e,t,r[s])},x.prototype.joinSelector=function(e,t,r){function s(e,t){var r,s;if(0===e.length)r=new b(e[0]);else{var i=new Array(e.length);for(s=0;s<e.length;s++)i[s]=new w(null,e[s],t.isVariable,t._index,t._fileInfo);r=new b(new I(i))}return r}function i(e,t){var r;return r=new w(null,e,t.isVariable,t._index,t._fileInfo),new I([r])}function n(e,t,r,s){var i,n,o;if(i=[],e.length>0?(n=(i=A.copyArray(e)).pop(),o=s.createDerived(A.copyArray(n.elements))):o=s.createDerived([]),t.length>0){var l=r.combinator,a=t[0].elements[0];l.emptyOrWhitespace&&!a.combinator.emptyOrWhitespace&&(l=a.combinator),o.elements.push(new w(l,a.value,r.isVariable,r._index,r._fileInfo)),o.elements=o.elements.concat(t[0].elements.slice(1))}if(0!==o.elements.length&&i.push(o),t.length>1){var u=t.slice(1);u=u.map(function(e){return e.createDerived(e.elements,[])}),i=i.concat(u)}return i}function o(e,t,r,s,i){var o;for(o=0;o<e.length;o++){var l=n(e[o],t,r,s);i.push(l)}return i}function l(e,t){var r,s;if(0!==e.length)if(0!==t.length)for(r=0;s=t[r];r++)s.length>0?s[s.length-1]=s[s.length-1].createDerived(s[s.length-1].elements.concat(e)):s.push(new I(e));else t.push([new I(e)])}function a(e,t){var r=t.createDerived(t.elements,t.extendList,t.evaldCondition);return r.copyVisibilityInfo(e),r}var u,h;if(!function e(t,r,a){var u,h,p,c,f,v,y,m,d,g,_,S,C=!1;for(c=[],f=[[]],u=0;m=a.elements[u];u++)if("&"!==m.value){var R=(S=void 0,(_=m).value instanceof b&&(S=_.value.value)instanceof I?S:null);if(null!=R){l(c,f);var k,A=[],x=[];for(k=e(A,r,R),C=C||k,p=0;p<A.length;p++)o(f,[i(s(A[p],m),m)],m,a,x);f=x,c=[]}else c.push(m)}else{for(C=!0,v=[],l(c,f),h=0;h<f.length;h++)if(y=f[h],0===r.length)y.length>0&&y[0].elements.push(new w(m.combinator,"",m.isVariable,m._index,m._fileInfo)),v.push(y);else for(p=0;p<r.length;p++){var V=n(y,r[p],m,a);v.push(V)}f=v,c=[]}for(l(c,f),u=0;u<f.length;u++)(d=f[u].length)>0&&(t.push(f[u]),g=f[u][d-1],f[u][d-1]=g.createDerived(g.elements,a.extendList));return C}(h=[],t,r))if(t.length>0)for(h=[],u=0;u<t.length;u++){var p=t[u].map(a.bind(this,r.visibilityInfo()));p.push(r),h.push(p)}else h=[[r]];for(u=0;u<h.length;u++)e.push(h[u])},v.exports=x,V(v.exports)?v.exports:V(f)?f:void 0});
//# sourceMappingURL=../../sourcemaps/engine/tree/ruleset.js.map
