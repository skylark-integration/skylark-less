{"version":3,"sources":["engine/tree/mixin-call.js"],"names":["define","__module__0","__module__1","__module__2","__module__3","exports","module","Selector","MixinDefinition","defaultFunc","MixinCall","elements","args","index","currentFileInfo","important","this","selector","arguments","_index","_fileInfo","allowRoot","setParent","__isValidToReturn","obj","Array","isArray","attr","__isEmptyObject","prototype","type","accept","visitor","visit","length","visitArray","eval","context","mixins","mixin","mixinPath","arg","argValue","i","m","f","isRecursive","isOneFound","candidate","defaultResult","count","originalRuleset","noArgumentsFilter","rules","match","candidates","conditionResult","defFalseEitherCase","defNone","defTrue","defFalse","calcDefGroup","p","namespace","value","matchCondition","expand","push","name","rule","matchArgs","frames","find","path","group","reset","message","format","getIndex","filename","fileInfo","visibilityInfo","newRules","evalCall","_setVisibilityToReplacement","apply","e","stack","toCSS","trim","replacement","blocksVisibility","addVisibilityBlock","map","a","join"],"mappings":"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","file":"../../../engine/tree/mixin-call.js","sourcesContent":["define([\n    './node',\n    './selector',\n    './mixin-definition',\n    '../functions/default'\n], function (__module__0, __module__1, __module__2, __module__3) {\n    'use strict';\n    var exports = {};\n    var module = { exports: {} };\n    var Node = __module__0, Selector = __module__1, MixinDefinition = __module__2, defaultFunc = __module__3;\n    var MixinCall = function (elements, args, index, currentFileInfo, important) {\n        this.selector = new Selector(elements);\n        this.arguments = args || [];\n        this._index = index;\n        this._fileInfo = currentFileInfo;\n        this.important = important;\n        this.allowRoot = true;\n        this.setParent(this.selector, this);\n    };\n    MixinCall.prototype = new Node();\n    MixinCall.prototype.type = 'MixinCall';\n    MixinCall.prototype.accept = function (visitor) {\n        if (this.selector) {\n            this.selector = visitor.visit(this.selector);\n        }\n        if (this.arguments.length) {\n            this.arguments = visitor.visitArray(this.arguments);\n        }\n    };\n    MixinCall.prototype.eval = function (context) {\n        var mixins, mixin, mixinPath, args = [], arg, argValue, rules = [], match = false, i, m, f, isRecursive, isOneFound, candidates = [], candidate, conditionResult = [], defaultResult, defFalseEitherCase = -1, defNone = 0, defTrue = 1, defFalse = 2, count, originalRuleset, noArgumentsFilter;\n        this.selector = this.selector.eval(context);\n        function calcDefGroup(mixin, mixinPath) {\n            var f, p, namespace;\n            for (f = 0; f < 2; f++) {\n                conditionResult[f] = true;\n                defaultFunc.value(f);\n                for (p = 0; p < mixinPath.length && conditionResult[f]; p++) {\n                    namespace = mixinPath[p];\n                    if (namespace.matchCondition) {\n                        conditionResult[f] = conditionResult[f] && namespace.matchCondition(null, context);\n                    }\n                }\n                if (mixin.matchCondition) {\n                    conditionResult[f] = conditionResult[f] && mixin.matchCondition(args, context);\n                }\n            }\n            if (conditionResult[0] || conditionResult[1]) {\n                if (conditionResult[0] != conditionResult[1]) {\n                    return conditionResult[1] ? defTrue : defFalse;\n                }\n                return defNone;\n            }\n            return defFalseEitherCase;\n        }\n        for (i = 0; i < this.arguments.length; i++) {\n            arg = this.arguments[i];\n            argValue = arg.value.eval(context);\n            if (arg.expand && Array.isArray(argValue.value)) {\n                argValue = argValue.value;\n                for (m = 0; m < argValue.length; m++) {\n                    args.push({ value: argValue[m] });\n                }\n            } else {\n                args.push({\n                    name: arg.name,\n                    value: argValue\n                });\n            }\n        }\n        noArgumentsFilter = function (rule) {\n            return rule.matchArgs(null, context);\n        };\n        for (i = 0; i < context.frames.length; i++) {\n            if ((mixins = context.frames[i].find(this.selector, null, noArgumentsFilter)).length > 0) {\n                isOneFound = true;\n                for (m = 0; m < mixins.length; m++) {\n                    mixin = mixins[m].rule;\n                    mixinPath = mixins[m].path;\n                    isRecursive = false;\n                    for (f = 0; f < context.frames.length; f++) {\n                        if (!(mixin instanceof MixinDefinition) && mixin === (context.frames[f].originalRuleset || context.frames[f])) {\n                            isRecursive = true;\n                            break;\n                        }\n                    }\n                    if (isRecursive) {\n                        continue;\n                    }\n                    if (mixin.matchArgs(args, context)) {\n                        candidate = {\n                            mixin: mixin,\n                            group: calcDefGroup(mixin, mixinPath)\n                        };\n                        if (candidate.group !== defFalseEitherCase) {\n                            candidates.push(candidate);\n                        }\n                        match = true;\n                    }\n                }\n                defaultFunc.reset();\n                count = [\n                    0,\n                    0,\n                    0\n                ];\n                for (m = 0; m < candidates.length; m++) {\n                    count[candidates[m].group]++;\n                }\n                if (count[defNone] > 0) {\n                    defaultResult = defFalse;\n                } else {\n                    defaultResult = defTrue;\n                    if (count[defTrue] + count[defFalse] > 1) {\n                        throw {\n                            type: 'Runtime',\n                            message: 'Ambiguous use of `default()` found when matching for `' + this.format(args) + '`',\n                            index: this.getIndex(),\n                            filename: this.fileInfo().filename\n                        };\n                    }\n                }\n                for (m = 0; m < candidates.length; m++) {\n                    candidate = candidates[m].group;\n                    if (candidate === defNone || candidate === defaultResult) {\n                        try {\n                            mixin = candidates[m].mixin;\n                            if (!(mixin instanceof MixinDefinition)) {\n                                originalRuleset = mixin.originalRuleset || mixin;\n                                mixin = new MixinDefinition('', [], mixin.rules, null, false, null, originalRuleset.visibilityInfo());\n                                mixin.originalRuleset = originalRuleset;\n                            }\n                            var newRules = mixin.evalCall(context, args, this.important).rules;\n                            this._setVisibilityToReplacement(newRules);\n                            Array.prototype.push.apply(rules, newRules);\n                        } catch (e) {\n                            throw {\n                                message: e.message,\n                                index: this.getIndex(),\n                                filename: this.fileInfo().filename,\n                                stack: e.stack\n                            };\n                        }\n                    }\n                }\n                if (match) {\n                    return rules;\n                }\n            }\n        }\n        if (isOneFound) {\n            throw {\n                type: 'Runtime',\n                message: 'No matching definition was found for `' + this.format(args) + '`',\n                index: this.getIndex(),\n                filename: this.fileInfo().filename\n            };\n        } else {\n            throw {\n                type: 'Name',\n                message: this.selector.toCSS().trim() + ' is undefined',\n                index: this.getIndex(),\n                filename: this.fileInfo().filename\n            };\n        }\n    };\n    MixinCall.prototype._setVisibilityToReplacement = function (replacement) {\n        var i, rule;\n        if (this.blocksVisibility()) {\n            for (i = 0; i < replacement.length; i++) {\n                rule = replacement[i];\n                rule.addVisibilityBlock();\n            }\n        }\n    };\n    MixinCall.prototype.format = function (args) {\n        return this.selector.toCSS().trim() + '(' + (args ? args.map(function (a) {\n            var argValue = '';\n            if (a.name) {\n                argValue += a.name + ':';\n            }\n            if (a.value.toCSS) {\n                argValue += a.value.toCSS();\n            } else {\n                argValue += '???';\n            }\n            return argValue;\n        }).join(', ') : '') + ')';\n    };\n    module.exports = MixinCall;\n    function __isEmptyObject(obj) {\n        var attr;\n        for (attr in obj)\n            return !1;\n        return !0;\n    }\n    function __isValidToReturn(obj) {\n        return typeof obj != 'object' || Array.isArray(obj) || !__isEmptyObject(obj);\n    }\n    if (__isValidToReturn(module.exports))\n        return module.exports;\n    else if (__isValidToReturn(exports))\n        return exports;\n});"]}