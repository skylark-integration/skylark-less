{"version":3,"sources":["engine/tree/media.js"],"names":["Ruleset","require","Value","Selector","Anonymous","Expression","AtRule","utils","Media","value","features","index","currentFileInfo","visibilityInfo","this","_index","_fileInfo","selectors","createEmptySelectors","rules","allowImports","copyVisibilityInfo","allowRoot","setParent","prototype","type","isRulesetLike","accept","visitor","visit","visitArray","genCSS","context","output","add","outputRuleset","eval","mediaBlocks","mediaPath","media","debugInfo","push","functionRegistry","frames","inherit","unshift","shift","pop","length","evalTop","evalNested","result","getIndex","fileInfo","multiMedia","i","path","concat","Array","isArray","permute","map","fragment","toCSS","splice","arr","rest","slice","j","bubbleSelectors","copyArray","module","exports"],"mappings":"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","file":"../../../engine/tree/media.js","sourcesContent":["var Ruleset = require('./ruleset'), Value = require('./value'), Selector = require('./selector'), Anonymous = require('./anonymous'), Expression = require('./expression'), AtRule = require('./atrule'), utils = require('../utils');\nvar Media = function (value, features, index, currentFileInfo, visibilityInfo) {\n    this._index = index;\n    this._fileInfo = currentFileInfo;\n    var selectors = new Selector([], null, null, this._index, this._fileInfo).createEmptySelectors();\n    this.features = new Value(features);\n    this.rules = [new Ruleset(selectors, value)];\n    this.rules[0].allowImports = true;\n    this.copyVisibilityInfo(visibilityInfo);\n    this.allowRoot = true;\n    this.setParent(selectors, this);\n    this.setParent(this.features, this);\n    this.setParent(this.rules, this);\n};\nMedia.prototype = new AtRule();\nMedia.prototype.type = 'Media';\nMedia.prototype.isRulesetLike = function () {\n    return true;\n};\nMedia.prototype.accept = function (visitor) {\n    if (this.features) {\n        this.features = visitor.visit(this.features);\n    }\n    if (this.rules) {\n        this.rules = visitor.visitArray(this.rules);\n    }\n};\nMedia.prototype.genCSS = function (context, output) {\n    output.add('@media ', this._fileInfo, this._index);\n    this.features.genCSS(context, output);\n    this.outputRuleset(context, output, this.rules);\n};\nMedia.prototype.eval = function (context) {\n    if (!context.mediaBlocks) {\n        context.mediaBlocks = [];\n        context.mediaPath = [];\n    }\n    var media = new Media(null, [], this._index, this._fileInfo, this.visibilityInfo());\n    if (this.debugInfo) {\n        this.rules[0].debugInfo = this.debugInfo;\n        media.debugInfo = this.debugInfo;\n    }\n    media.features = this.features.eval(context);\n    context.mediaPath.push(media);\n    context.mediaBlocks.push(media);\n    this.rules[0].functionRegistry = context.frames[0].functionRegistry.inherit();\n    context.frames.unshift(this.rules[0]);\n    media.rules = [this.rules[0].eval(context)];\n    context.frames.shift();\n    context.mediaPath.pop();\n    return context.mediaPath.length === 0 ? media.evalTop(context) : media.evalNested(context);\n};\nMedia.prototype.evalTop = function (context) {\n    var result = this;\n    if (context.mediaBlocks.length > 1) {\n        var selectors = new Selector([], null, null, this.getIndex(), this.fileInfo()).createEmptySelectors();\n        result = new Ruleset(selectors, context.mediaBlocks);\n        result.multiMedia = true;\n        result.copyVisibilityInfo(this.visibilityInfo());\n        this.setParent(result, this);\n    }\n    delete context.mediaBlocks;\n    delete context.mediaPath;\n    return result;\n};\nMedia.prototype.evalNested = function (context) {\n    var i, value, path = context.mediaPath.concat([this]);\n    for (i = 0; i < path.length; i++) {\n        value = path[i].features instanceof Value ? path[i].features.value : path[i].features;\n        path[i] = Array.isArray(value) ? value : [value];\n    }\n    this.features = new Value(this.permute(path).map(function (path) {\n        path = path.map(function (fragment) {\n            return fragment.toCSS ? fragment : new Anonymous(fragment);\n        });\n        for (i = path.length - 1; i > 0; i--) {\n            path.splice(i, 0, new Anonymous('and'));\n        }\n        return new Expression(path);\n    }));\n    this.setParent(this.features, this);\n    return new Ruleset([], []);\n};\nMedia.prototype.permute = function (arr) {\n    if (arr.length === 0) {\n        return [];\n    } else if (arr.length === 1) {\n        return arr[0];\n    } else {\n        var result = [];\n        var rest = this.permute(arr.slice(1));\n        for (var i = 0; i < rest.length; i++) {\n            for (var j = 0; j < arr[0].length; j++) {\n                result.push([arr[0][j]].concat(rest[i]));\n            }\n        }\n        return result;\n    }\n};\nMedia.prototype.bubbleSelectors = function (selectors) {\n    if (!selectors) {\n        return;\n    }\n    this.rules = [new Ruleset(utils.copyArray(selectors), [this.rules[0]])];\n    this.setParent(this.rules, this);\n};\nmodule.exports = Media;"]}