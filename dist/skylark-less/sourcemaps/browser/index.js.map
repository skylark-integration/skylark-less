{"version":3,"sources":["browser/index.js"],"names":["addDataAttr","require","browser","module","exports","window","options","document","less","environment","FileManager","logger","fileManager","addFileManager","PluginLoader","errors","cache","functions","functionRegistry","addMultiple","typePattern","clone","obj","cloned","prop","hasOwnProperty","bind","func","thisArg","curryArgs","Array","prototype","slice","call","arguments","args","concat","apply","loadStyles","modifyVars","style","styles","getElementsByTagName","i","length","type","match","instanceOptions","lessText","innerHTML","filename","location","href","replace","render","e","result","add","styleSheet","cssText","css","loadStyleSheet","sheet","callback","reload","remaining","mime","loadFile","then","loadedFile","data","contents","path","webInfo","newFileInfo","currentDirectory","getPath","rootFilename","rewriteUrls","entryPath","rootpath","getCSS","local","remove","rootFileInfo","setCSS","lastModified","loadInitialFileCallback","catch","err","console","log","loadStyleSheets","sheets","watch","watchMode","env","watchTimer","setInterval","clearFileCache","_","createCSS","poll","this","unwatch","clearInterval","registerStylesheetsImmediately","links","rel","push","registerStylesheets","Promise","resolve","reject","record","refresh","startTime","endTime","totalMilliseconds","remainingSheets","Date","info","refreshStyles"],"mappings":"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","file":"../../browser/index.js","sourcesContent":["var addDataAttr = require('./utils').addDataAttr, browser = require('./browser');\nmodule.exports = function (window, options) {\n    var document = window.document;\n    var less = require('../less')();\n    less.options = options;\n    var environment = less.environment, FileManager = require('./file-manager')(options, less.logger), fileManager = new FileManager();\n    environment.addFileManager(fileManager);\n    less.FileManager = FileManager;\n    less.PluginLoader = require('./plugin-loader');\n    require('./log-listener')(less, options);\n    var errors = require('./error-reporting')(window, less, options);\n    var cache = less.cache = options.cache || require('./cache')(window, options, less.logger);\n    require('./image-size')(less.environment);\n    if (options.functions) {\n        less.functions.functionRegistry.addMultiple(options.functions);\n    }\n    var typePattern = /^text\\/(x-)?less$/;\n    function clone(obj) {\n        var cloned = {};\n        for (var prop in obj) {\n            if (obj.hasOwnProperty(prop)) {\n                cloned[prop] = obj[prop];\n            }\n        }\n        return cloned;\n    }\n    function bind(func, thisArg) {\n        var curryArgs = Array.prototype.slice.call(arguments, 2);\n        return function () {\n            var args = curryArgs.concat(Array.prototype.slice.call(arguments, 0));\n            return func.apply(thisArg, args);\n        };\n    }\n    function loadStyles(modifyVars) {\n        var styles = document.getElementsByTagName('style'), style;\n        for (var i = 0; i < styles.length; i++) {\n            style = styles[i];\n            if (style.type.match(typePattern)) {\n                var instanceOptions = clone(options);\n                instanceOptions.modifyVars = modifyVars;\n                var lessText = style.innerHTML || '';\n                instanceOptions.filename = document.location.href.replace(/#.*$/, '');\n                less.render(lessText, instanceOptions, bind(function (style, e, result) {\n                    if (e) {\n                        errors.add(e, 'inline');\n                    } else {\n                        style.type = 'text/css';\n                        if (style.styleSheet) {\n                            style.styleSheet.cssText = result.css;\n                        } else {\n                            style.innerHTML = result.css;\n                        }\n                    }\n                }, null, style));\n            }\n        }\n    }\n    function loadStyleSheet(sheet, callback, reload, remaining, modifyVars) {\n        var instanceOptions = clone(options);\n        addDataAttr(instanceOptions, sheet);\n        instanceOptions.mime = sheet.type;\n        if (modifyVars) {\n            instanceOptions.modifyVars = modifyVars;\n        }\n        function loadInitialFileCallback(loadedFile) {\n            var data = loadedFile.contents, path = loadedFile.filename, webInfo = loadedFile.webInfo;\n            var newFileInfo = {\n                currentDirectory: fileManager.getPath(path),\n                filename: path,\n                rootFilename: path,\n                rewriteUrls: instanceOptions.rewriteUrls\n            };\n            newFileInfo.entryPath = newFileInfo.currentDirectory;\n            newFileInfo.rootpath = instanceOptions.rootpath || newFileInfo.currentDirectory;\n            if (webInfo) {\n                webInfo.remaining = remaining;\n                var css = cache.getCSS(path, webInfo, instanceOptions.modifyVars);\n                if (!reload && css) {\n                    webInfo.local = true;\n                    callback(null, css, data, sheet, webInfo, path);\n                    return;\n                }\n            }\n            errors.remove(path);\n            instanceOptions.rootFileInfo = newFileInfo;\n            less.render(data, instanceOptions, function (e, result) {\n                if (e) {\n                    e.href = path;\n                    callback(e);\n                } else {\n                    cache.setCSS(sheet.href, webInfo.lastModified, instanceOptions.modifyVars, result.css);\n                    callback(null, result.css, data, sheet, webInfo, path);\n                }\n            });\n        }\n        fileManager.loadFile(sheet.href, null, instanceOptions, environment).then(function (loadedFile) {\n            loadInitialFileCallback(loadedFile);\n        }).catch(function (err) {\n            console.log(err);\n            callback(err);\n        });\n    }\n    function loadStyleSheets(callback, reload, modifyVars) {\n        for (var i = 0; i < less.sheets.length; i++) {\n            loadStyleSheet(less.sheets[i], callback, reload, less.sheets.length - (i + 1), modifyVars);\n        }\n    }\n    function initRunningMode() {\n        if (less.env === 'development') {\n            less.watchTimer = setInterval(function () {\n                if (less.watchMode) {\n                    fileManager.clearFileCache();\n                    loadStyleSheets(function (e, css, _, sheet, webInfo) {\n                        if (e) {\n                            errors.add(e, e.href || sheet.href);\n                        } else if (css) {\n                            browser.createCSS(window.document, css, sheet);\n                        }\n                    });\n                }\n            }, options.poll);\n        }\n    }\n    less.watch = function () {\n        if (!less.watchMode) {\n            less.env = 'development';\n            initRunningMode();\n        }\n        this.watchMode = true;\n        return true;\n    };\n    less.unwatch = function () {\n        clearInterval(less.watchTimer);\n        this.watchMode = false;\n        return false;\n    };\n    less.registerStylesheetsImmediately = function () {\n        var links = document.getElementsByTagName('link');\n        less.sheets = [];\n        for (var i = 0; i < links.length; i++) {\n            if (links[i].rel === 'stylesheet/less' || links[i].rel.match(/stylesheet/) && links[i].type.match(typePattern)) {\n                less.sheets.push(links[i]);\n            }\n        }\n    };\n    less.registerStylesheets = function () {\n        return new Promise(function (resolve, reject) {\n            less.registerStylesheetsImmediately();\n            resolve();\n        });\n    };\n    less.modifyVars = function (record) {\n        return less.refresh(true, record, false);\n    };\n    less.refresh = function (reload, modifyVars, clearFileCache) {\n        if ((reload || clearFileCache) && clearFileCache !== false) {\n            fileManager.clearFileCache();\n        }\n        return new Promise(function (resolve, reject) {\n            var startTime, endTime, totalMilliseconds, remainingSheets;\n            startTime = endTime = new Date();\n            remainingSheets = less.sheets.length;\n            if (remainingSheets === 0) {\n                endTime = new Date();\n                totalMilliseconds = endTime - startTime;\n                less.logger.info('Less has finished and no sheets were loaded.');\n                resolve({\n                    startTime: startTime,\n                    endTime: endTime,\n                    totalMilliseconds: totalMilliseconds,\n                    sheets: less.sheets.length\n                });\n            } else {\n                loadStyleSheets(function (e, css, _, sheet, webInfo) {\n                    if (e) {\n                        errors.add(e, e.href || sheet.href);\n                        reject(e);\n                        return;\n                    }\n                    if (webInfo.local) {\n                        less.logger.info('Loading ' + sheet.href + ' from cache.');\n                    } else {\n                        less.logger.info('Rendered ' + sheet.href + ' successfully.');\n                    }\n                    browser.createCSS(window.document, css, sheet);\n                    less.logger.info('CSS for ' + sheet.href + ' generated in ' + (new Date() - endTime) + 'ms');\n                    remainingSheets--;\n                    if (remainingSheets === 0) {\n                        totalMilliseconds = new Date() - startTime;\n                        less.logger.info('Less has finished. CSS generated in ' + totalMilliseconds + 'ms');\n                        resolve({\n                            startTime: startTime,\n                            endTime: endTime,\n                            totalMilliseconds: totalMilliseconds,\n                            sheets: less.sheets.length\n                        });\n                    }\n                    endTime = new Date();\n                }, reload, modifyVars);\n            }\n            loadStyles(modifyVars);\n        });\n    };\n    less.refreshStyles = loadStyles;\n    return less;\n};"]}