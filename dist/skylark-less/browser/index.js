/**
 * skylark-less - A version of less.js that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylarkui/skylark-less/
 * @license MIT
 */
var addDataAttr=require("./utils").addDataAttr,browser=require("./browser");module.exports=function(e,r){var t=e.document,n=require("../less")();n.options=r;var i=n.environment,a=require("./file-manager")(r,n.logger),o=new a;i.addFileManager(o),n.FileManager=a,n.PluginLoader=require("./plugin-loader"),require("./log-listener")(n,r);var s=require("./error-reporting")(e,n,r),l=n.cache=r.cache||require("./cache")(e,r,n.logger);require("./image-size")(n.environment),r.functions&&n.functions.functionRegistry.addMultiple(r.functions);var c=/^text\/(x-)?less$/;function f(e){var r={};for(var t in e)e.hasOwnProperty(t)&&(r[t]=e[t]);return r}function h(e,r){var t=Array.prototype.slice.call(arguments,2);return function(){var n=t.concat(Array.prototype.slice.call(arguments,0));return e.apply(r,n)}}function u(e){for(var i,a=t.getElementsByTagName("style"),o=0;o<a.length;o++)if((i=a[o]).type.match(c)){var l=f(r);l.modifyVars=e;var u=i.innerHTML||"";l.filename=t.location.href.replace(/#.*$/,""),n.render(u,l,h(function(e,r,t){r?s.add(r,"inline"):(e.type="text/css",e.styleSheet?e.styleSheet.cssText=t.css:e.innerHTML=t.css)},null,i))}}function d(e,t,a,c,h){var u=f(r);addDataAttr(u,e),u.mime=e.type,h&&(u.modifyVars=h),o.loadFile(e.href,null,u,i).then(function(r){!function(r){var i=r.contents,f=r.filename,h=r.webInfo,d={currentDirectory:o.getPath(f),filename:f,rootFilename:f,rewriteUrls:u.rewriteUrls};if(d.entryPath=d.currentDirectory,d.rootpath=u.rootpath||d.currentDirectory,h){h.remaining=c;var m=l.getCSS(f,h,u.modifyVars);if(!a&&m)return h.local=!0,void t(null,m,i,e,h,f)}s.remove(f),u.rootFileInfo=d,n.render(i,u,function(r,n){r?(r.href=f,t(r)):(l.setCSS(e.href,h.lastModified,u.modifyVars,n.css),t(null,n.css,i,e,h,f))})}(r)}).catch(function(e){console.log(e),t(e)})}function m(e,r,t){for(var i=0;i<n.sheets.length;i++)d(n.sheets[i],e,r,n.sheets.length-(i+1),t)}return n.watch=function(){return n.watchMode||(n.env="development","development"===n.env&&(n.watchTimer=setInterval(function(){n.watchMode&&(o.clearFileCache(),m(function(r,t,n,i,a){r?s.add(r,r.href||i.href):t&&browser.createCSS(e.document,t,i)}))},r.poll))),this.watchMode=!0,!0},n.unwatch=function(){return clearInterval(n.watchTimer),this.watchMode=!1,!1},n.registerStylesheetsImmediately=function(){var e=t.getElementsByTagName("link");n.sheets=[];for(var r=0;r<e.length;r++)("stylesheet/less"===e[r].rel||e[r].rel.match(/stylesheet/)&&e[r].type.match(c))&&n.sheets.push(e[r])},n.registerStylesheets=function(){return new Promise(function(e,r){n.registerStylesheetsImmediately(),e()})},n.modifyVars=function(e){return n.refresh(!0,e,!1)},n.refresh=function(r,t,i){return(r||i)&&!1!==i&&o.clearFileCache(),new Promise(function(i,a){var o,l,c,f;o=l=new Date,0===(f=n.sheets.length)?(l=new Date,c=l-o,n.logger.info("Less has finished and no sheets were loaded."),i({startTime:o,endTime:l,totalMilliseconds:c,sheets:n.sheets.length})):m(function(r,t,h,u,d){if(r)return s.add(r,r.href||u.href),void a(r);d.local?n.logger.info("Loading "+u.href+" from cache."):n.logger.info("Rendered "+u.href+" successfully."),browser.createCSS(e.document,t,u),n.logger.info("CSS for "+u.href+" generated in "+(new Date-l)+"ms"),0===--f&&(c=new Date-o,n.logger.info("Less has finished. CSS generated in "+c+"ms"),i({startTime:o,endTime:l,totalMilliseconds:c,sheets:n.sheets.length})),l=new Date},r,t),u(t)})},n.refreshStyles=u,n};
//# sourceMappingURL=../sourcemaps/browser/index.js.map
